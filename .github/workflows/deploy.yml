name: ğŸš€ CI/CD - Deploy JusCash API

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  test:
    name: ğŸ§ª Testes Automatizados
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Cache dependÃªncias Python
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ğŸ“‹ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8

    - name: ğŸ” Lint com flake8
      run: |
        flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: ğŸ§ª Executar testes
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test-secret-key
        FLASK_ENV: testing
      run: |
        flask db upgrade
        pytest tests/ -v --cov=app --cov-report=xml --cov-report=term

  deploy:
    name: ğŸš€ Deploy para VPS
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    environment:
      name: production
      url: https://cron.juscash.app

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: ğŸ“‹ Adicionar servidor aos hosts conhecidos
      run: |
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸš€ Deploy com Tag de Imagem
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USER }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ğŸš€ Deploy DRÃSTICO com tag de imagem: ${IMAGE_TAG:0:7}"
        
        ssh $VPS_USER@$VPS_HOST << EOF
          set -e
          
          # Configurar logging detalhado
          DEPLOY_LOG="/var/www/juscash/deploy_\$(date +%Y%m%d_%H%M%S).log"
          exec > >(tee -a "\$DEPLOY_LOG") 2>&1
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                ğŸš€ DEPLOY COM LOGS DETALHADOS                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”„ Deploy iniciado: \$(date)"
          echo "ğŸ“‹ Tag da imagem: ${IMAGE_TAG:0:7}"
          echo "ğŸ“ Log sendo salvo em: \$DEPLOY_LOG"
          
          cd /var/www/juscash
          echo "ğŸ“ DiretÃ³rio atual: \$(pwd)"
          echo "ğŸ‘¤ UsuÃ¡rio atual: \$(whoami)"
          echo "ğŸ” PermissÃµes do diretÃ³rio: \$(ls -la . | head -5)"
          
          # 1. Backup rÃ¡pido
          echo ""
          echo "ğŸ’¾ === ETAPA 1: BACKUP ==="
          if docker-compose exec -T db pg_dump -U juscash juscash_db > backup_\$(date +%Y%m%d_%H%M%S).sql 2>/dev/null; then
            echo "âœ… Backup criado com sucesso"
          else
            echo "âš ï¸ Backup falhou - continuando deploy..."
          fi
          
          # 2. VERIFICAR ESTADO ATUAL DO GIT
          echo ""
          echo "ğŸ“¥ === ETAPA 2: VERIFICAR GIT ==="
          echo "ğŸ” Status do Git antes:"
          git status || echo "âŒ Erro ao verificar status do git"
          echo "ğŸ” Branch atual: \$(git branch --show-current 2>/dev/null || echo 'desconhecido')"
          echo "ğŸ” Ãšltimo commit local: \$(git log --oneline -1 2>/dev/null || echo 'erro ao obter commit')"
          echo "ğŸ” Remote origin: \$(git remote get-url origin 2>/dev/null || echo 'sem remote')"
          
          # 3. PARAR CONTAINERS COM LOGS
          echo ""
          echo "ğŸ›‘ === ETAPA 3: PARAR CONTAINERS ==="
          echo "ğŸ“Š Containers antes de parar:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || echo "âŒ Erro ao listar containers"
          
          echo "â¹ï¸ Parando containers com docker-compose..."
          docker-compose down --remove-orphans --volumes 2>&1 || echo "âš ï¸ Erro ao parar com docker-compose"
          
          echo "â¹ï¸ Parando todos os containers Docker..."
          docker stop \$(docker ps -aq) 2>/dev/null || echo "âš ï¸ Nenhum container para parar"
          docker rm \$(docker ps -aq) 2>/dev/null || echo "âš ï¸ Nenhum container para remover"
          
          # 4. LIMPEZA DE IMAGENS COM LOGS
          echo ""
          echo "ğŸ—‘ï¸ === ETAPA 4: LIMPEZA DE IMAGENS ==="
          echo "ğŸ” Imagens antes da limpeza:"
          docker images | grep -E "(juscash|<none>)" || echo "âš ï¸ Nenhuma imagem juscash encontrada"
          
          echo "ğŸ—‘ï¸ Removendo imagens juscash..."
          docker rmi \$(docker images -q --filter "reference=juscash*") 2>/dev/null || echo "âš ï¸ Nenhuma imagem juscash para remover"
          
          echo "ğŸ—‘ï¸ Removendo imagens Ã³rfÃ£s..."
          docker rmi \$(docker images -q --filter "dangling=true") 2>/dev/null || echo "âš ï¸ Nenhuma imagem Ã³rfÃ£ para remover"
          
          echo "ğŸ§¹ Limpeza completa do sistema Docker..."
          docker system prune -af --volumes 2>&1 || echo "âš ï¸ Erro na limpeza do sistema"
          
          # 5. ATUALIZAR CÃ“DIGO COM LOGS DETALHADOS
          echo ""
          echo "ğŸ“¥ === ETAPA 5: ATUALIZAR CÃ“DIGO ==="
          
          echo "ğŸ§¹ Limpando arquivos de conflito..."
          git stash push -m "Deploy stash \$(date)" --include-untracked 2>&1 || echo "âš ï¸ Nada para fazer stash"
          
          echo "ğŸ—‘ï¸ Removendo arquivos nÃ£o rastreados..."
          git clean -fd 2>&1 || echo "âš ï¸ Erro na limpeza de arquivos"
          
          echo "ğŸ”„ Fazendo fetch do origin..."
          if git fetch origin 2>&1; then
            echo "âœ… Fetch realizado com sucesso"
          else
            echo "âŒ ERRO NO FETCH! Tentando diagnosticar..."
            echo "ğŸ” Conectividade de rede:"
            ping -c 3 github.com || echo "âŒ Sem conectividade com GitHub"
            echo "ğŸ” ConfiguraÃ§Ã£o do Git:"
            git config --list | grep -E "(remote|url)" || echo "âŒ Erro na configuraÃ§Ã£o do Git"
          fi
          
          echo "ğŸ”„ Fazendo reset hard para origin/master..."
          if git reset --hard origin/master 2>&1; then
            echo "âœ… Reset realizado com sucesso"
          else
            echo "âŒ ERRO NO RESET! Estado atual:"
            git status
            echo "ğŸ” Tentando reset alternativo..."
            git reset --hard HEAD 2>&1 || echo "âŒ Reset alternativo tambÃ©m falhou"
          fi
          
          echo "ğŸ§¹ Limpeza final de arquivos nÃ£o rastreados..."
          git clean -fd 2>&1 || echo "âš ï¸ Erro na limpeza final"
          
          echo "ğŸ” Estado apÃ³s atualizaÃ§Ã£o:"
          echo "   - Branch: \$(git branch --show-current 2>/dev/null || echo 'desconhecido')"
          echo "   - Commit: \$(git log --oneline -1 2>/dev/null || echo 'erro')"
          echo "   - Status: \$(git status --porcelain 2>/dev/null | wc -l) arquivos modificados"
          
          # 6. CRIAR ARQUIVO VERSION COM LOGS
          echo ""
          echo "ğŸ“ === ETAPA 6: CRIAR ARQUIVO VERSION ==="
          echo "ğŸ“ Criando arquivo VERSION com hash: ${IMAGE_TAG:0:7}"
          echo "${IMAGE_TAG:0:7}" > VERSION
          if [ -f VERSION ]; then
            echo "âœ… Arquivo VERSION criado: \$(cat VERSION)"
            echo "ğŸ“‹ PermissÃµes do arquivo: \$(ls -la VERSION)"
          else
            echo "âŒ ERRO: Arquivo VERSION nÃ£o foi criado!"
          fi
          
          # 7. MODIFICAR CÃ“DIGO COM LOGS
          echo ""
          echo "ğŸ”§ === ETAPA 7: MODIFICAR CÃ“DIGO ==="
          echo "ğŸ”§ Modificando routes.py para forÃ§ar versÃ£o..."
          if sed -i "s/return 'unknown'/return '\$(cat VERSION)'/g" app/presentation/routes.py; then
            echo "âœ… ModificaÃ§Ã£o 1 realizada"
          else
            echo "âŒ Erro na modificaÃ§Ã£o 1"
          fi
          
          if sed -i "s/return 'error_reading_version'/return '\$(cat VERSION)'/g" app/presentation/routes.py; then
            echo "âœ… ModificaÃ§Ã£o 2 realizada"
          else
            echo "âŒ Erro na modificaÃ§Ã£o 2"
          fi
          
          # 8. MODIFICAR DOCKERFILE COM LOGS
          echo ""
          echo "ğŸ³ === ETAPA 8: MODIFICAR DOCKERFILE ==="
          echo "ğŸ“‹ Dockerfile antes da modificaÃ§Ã£o:"
          tail -5 Dockerfile || echo "âŒ Erro ao ler Dockerfile"
          
          echo "ğŸ“ Adicionando VERSION e ENV ao Dockerfile..."
          echo "COPY VERSION /app/VERSION" >> Dockerfile
          echo "ENV DEPLOY_VERSION=${IMAGE_TAG:0:7}" >> Dockerfile
          
          echo "ğŸ“‹ Dockerfile apÃ³s modificaÃ§Ã£o:"
          tail -5 Dockerfile || echo "âŒ Erro ao ler Dockerfile modificado"
          
          # 9. BUILD COM LOGS DETALHADOS
          echo ""
          echo "ğŸ”¨ === ETAPA 9: BUILD DO DOCKER ==="
          echo "ğŸ”¨ Iniciando build completo do zero..."
          if docker-compose build --no-cache --pull --force-rm 2>&1; then
            echo "âœ… Build concluÃ­do com sucesso"
          else
            echo "âŒ ERRO NO BUILD!"
            echo "ğŸ” Verificando se o docker-compose.yml existe:"
            ls -la docker-compose.yml || echo "âŒ docker-compose.yml nÃ£o encontrado"
            echo "ğŸ” Verificando se o Dockerfile existe:"
            ls -la Dockerfile || echo "âŒ Dockerfile nÃ£o encontrado"
            exit 1
          fi
          
          # 10. INICIAR CONTAINERS COM LOGS
          echo ""
          echo "ğŸš€ === ETAPA 10: INICIAR CONTAINERS ==="
          echo "ğŸš€ Iniciando containers..."
          if docker-compose up -d 2>&1; then
            echo "âœ… Containers iniciados"
          else
            echo "âŒ ERRO AO INICIAR CONTAINERS!"
            echo "ğŸ” Logs de erro:"
            docker-compose logs --tail=20 2>&1 || echo "âŒ Erro ao obter logs"
            exit 1
          fi
          
          # 11. AGUARDAR E VERIFICAR
          echo ""
          echo "â³ === ETAPA 11: AGUARDAR INICIALIZAÃ‡ÃƒO ==="
          echo "â³ Aguardando 60 segundos para inicializaÃ§Ã£o completa..."
          for i in {1..60}; do
            echo -n "."
            sleep 1
            if [ \$((i % 10)) -eq 0 ]; then
              echo " [\$i/60]"
            fi
          done
          echo ""
          
          # 12. VERIFICAÃ‡Ã•ES DETALHADAS
          echo ""
          echo "ğŸ” === ETAPA 12: VERIFICAÃ‡Ã•ES ==="
          echo "ğŸ“Š Status dos containers:"
          docker-compose ps || echo "âŒ Erro ao verificar status"
          
          echo "ğŸ” Verificando arquivo VERSION no container:"
          docker-compose exec -T web ls -la /app/VERSION 2>&1 || echo "âŒ Arquivo VERSION nÃ£o encontrado no container"
          docker-compose exec -T web cat /app/VERSION 2>&1 || echo "âŒ NÃ£o foi possÃ­vel ler arquivo VERSION no container"
          
          echo "ğŸ” Verificando variÃ¡vel de ambiente:"
          docker-compose exec -T web env | grep DEPLOY_VERSION 2>&1 || echo "âŒ VariÃ¡vel DEPLOY_VERSION nÃ£o encontrada"
          
          echo "ğŸ“‹ Logs recentes do container web:"
          docker-compose logs web --tail=20 || echo "âŒ Erro ao obter logs do container"
          
          # 13. TESTE DA API
          echo ""
          echo "ğŸ¥ === ETAPA 13: TESTE DA API ==="
          SUCCESS=false
          for i in {1..20}; do
            echo "ğŸ” Teste \$i/20..."
            if curl -f -s --max-time 20 http://localhost:5000/api/simple/ping > /tmp/health.json 2>&1; then
              API_VERSION=\$(cat /tmp/health.json | python3 -c "import json,sys; print(json.load(sys.stdin).get('version', 'unknown'))" 2>/dev/null || echo "unknown")
              echo "âœ… API respondendo! VersÃ£o: \$API_VERSION"
              echo "ğŸ“‹ Resposta completa:"
              cat /tmp/health.json | python3 -m json.tool 2>/dev/null || cat /tmp/health.json
              
              if [ "\$API_VERSION" = "${IMAGE_TAG:0:7}" ]; then
                echo "ğŸ‰ VERSÃƒO ATUALIZADA CORRETAMENTE!"
                SUCCESS=true
                break
              else
                echo "âš ï¸ VersÃ£o nÃ£o coincide (esperado: ${IMAGE_TAG:0:7}, atual: \$API_VERSION)"
              fi
              break
            else
              echo "âŒ API nÃ£o estÃ¡ respondendo - tentativa \$i/20"
              if [ \$i -eq 5 ] || [ \$i -eq 10 ] || [ \$i -eq 15 ]; then
                echo "ğŸ“‹ Logs do container:"
                docker-compose logs web --tail=10 || echo "âŒ Erro ao obter logs"
              fi
              sleep 5
            fi
          done
          
          # 14. MIGRAÃ‡Ã•ES
          echo ""
          echo "ğŸ—„ï¸ === ETAPA 14: MIGRAÃ‡Ã•ES ==="
          if docker-compose exec -T web flask db upgrade 2>&1; then
            echo "âœ… MigraÃ§Ãµes aplicadas com sucesso"
          else
            echo "âš ï¸ Erro nas migraÃ§Ãµes - continuando..."
          fi
          
          # 15. LIMPEZA FINAL
          echo ""
          echo "ğŸ”„ === ETAPA 15: LIMPEZA FINAL ==="
          echo "ğŸ”„ Revertendo modificaÃ§Ãµes temporÃ¡rias..."
          git checkout -- app/presentation/routes.py Dockerfile 2>&1 || echo "âš ï¸ Erro ao reverter modificaÃ§Ãµes"
          
          # 16. RESULTADO FINAL
          echo ""
          echo "ğŸ“Š === RESULTADO FINAL ==="
          if [ "\$SUCCESS" = true ]; then
            echo "âœ… DEPLOY CONCLUÃDO COM SUCESSO!"
          else
            echo "âŒ Deploy executado, mas versÃ£o pode nÃ£o ter atualizado"
          fi
          
          echo "ğŸ“ Log completo salvo em: \$DEPLOY_LOG"
          echo "ğŸŒ Acesse: https://cron.juscash.app/api/simple/ping"
          echo "ğŸ“… Deploy finalizado: \$(date)"
        EOF

    - name: ğŸ”” VerificaÃ§Ã£o Externa Final
      run: |
        echo "ğŸŒ Aguardando propagaÃ§Ã£o externa..."
        sleep 20
        
        echo "ğŸ“¡ Verificando versÃ£o externa..."
        EXPECTED_VERSION="${{ github.sha }}"
        EXPECTED_SHORT="${EXPECTED_VERSION:0:7}"
        
        for i in {1..8}; do
          if curl -f -s --max-time 15 https://cron.juscash.app/api/simple/ping > /tmp/api_response.json 2>/dev/null; then
            echo "âœ… API externa acessÃ­vel!"
            echo "ğŸ“‹ Resposta:"
            cat /tmp/api_response.json
            
            # Extrair versÃ£o usando jq se disponÃ­vel, senÃ£o usar python
            if command -v jq >/dev/null 2>&1; then
              VERSION=$(jq -r '.version // "unknown"' /tmp/api_response.json)
            else
              VERSION=$(python3 -c 'import json,sys; print(json.load(open("/tmp/api_response.json")).get("version", "unknown"))' 2>/dev/null || echo "unknown")
            fi
            
            echo "ğŸ”– VersÃ£o externa: $VERSION"
            echo "ğŸ”– VersÃ£o esperada: $EXPECTED_SHORT"
            
            if [ "$VERSION" = "$EXPECTED_SHORT" ]; then
              echo "ğŸ‰ VersÃ£o atualizada corretamente!"
            else
              echo "âš ï¸ VersÃ£o ainda nÃ£o atualizada"
            fi
            
            break
          else
            echo "âš ï¸ Tentativa $i/8 falhou, aguardando..."
            sleep 10
          fi
        done

    - name: âŒ Notificar se falhou
      if: failure()
      run: |
        echo "âŒ Deploy falhou!"
        echo "ğŸ“‹ Commit: ${{ github.sha }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ” Verifique os logs acima para mais detalhes" 