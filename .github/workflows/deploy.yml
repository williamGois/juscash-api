name: 🚀 CI/CD - Deploy JusCash API

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  test:
    name: 🧪 Testes Automatizados
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: 📥 Checkout código
      uses: actions/checkout@v4

    - name: 🐍 Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: 📦 Cache dependências Python
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: 📋 Instalar dependências
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8

    - name: 🔍 Lint com flake8
      run: |
        flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: 🧪 Executar testes
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test-secret-key
        FLASK_ENV: testing
      run: |
        flask db upgrade
        pytest tests/ -v --cov=app --cov-report=xml --cov-report=term

  deploy:
    name: 🚀 Deploy para VPS
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    environment:
      name: production
      url: https://cron.juscash.app

    steps:
    - name: 📥 Checkout código
      uses: actions/checkout@v4

    - name: 🔐 Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: 📋 Adicionar servidor aos hosts conhecidos
      run: |
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: 🚀 Deploy com Tag de Imagem
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USER }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "🚀 Deploy com tag de imagem: ${IMAGE_TAG:0:7}"
        
        ssh $VPS_USER@$VPS_HOST << EOF
          set -e
          
          echo "🔄 Deploy iniciado: \$(date)"
          echo "📋 Tag da imagem: ${IMAGE_TAG:0:7}"
          
          cd /var/www/juscash
          
          # 1. Backup rápido
          echo "💾 Backup..."
          docker-compose exec -T db pg_dump -U juscash juscash_db > backup_\$(date +%Y%m%d_%H%M%S).sql 2>/dev/null || echo "⚠️ Backup falhou"
          
          # 2. Atualizar código
          echo "📥 Atualizando código..."
          git fetch origin
          git reset --hard origin/master
          
          # 3. Criar arquivo VERSION com hash do commit
          echo "${IMAGE_TAG:0:7}" > VERSION
          echo "✅ Versão criada: \$(cat VERSION)"
          
          # 4. Parar containers completamente
          echo "⏹️ Parando containers..."
          docker-compose down --remove-orphans --volumes || true
          
          # 5. Remover imagens antigas da aplicação (forçar rebuild)
          echo "🧹 Removendo imagens antigas..."
          docker rmi juscash_web:latest juscash_worker:latest juscash_flower:latest 2>/dev/null || true
          docker image prune -f || true
          
          # 6. Atualizar docker-compose.yml com nova tag
          echo "🏷️ Atualizando tags no docker-compose..."
          sed -i "s|image: juscash_web:.*|image: juscash_web:${IMAGE_TAG:0:7}|g" docker-compose.yml
          sed -i "s|image: juscash_worker:.*|image: juscash_worker:${IMAGE_TAG:0:7}|g" docker-compose.yml
          sed -i "s|image: juscash_flower:.*|image: juscash_flower:${IMAGE_TAG:0:7}|g" docker-compose.yml
          
          # 7. Build com nova tag
          echo "🔨 Build com nova tag..."
          docker-compose build --no-cache --pull
          
          # 8. Tagear imagens com hash do commit
          docker tag juscash_web:latest juscash_web:${IMAGE_TAG:0:7}
          docker tag juscash_worker:latest juscash_worker:${IMAGE_TAG:0:7}
          docker tag juscash_flower:latest juscash_flower:${IMAGE_TAG:0:7}
          
          # 9. Iniciar containers
          echo "🚀 Iniciando containers..."
          docker-compose up -d
          
          # 10. Aguardar inicialização
          echo "⏳ Aguardando 45 segundos..."
          sleep 45
          
          # 11. Verificar status
          echo "📊 Status dos containers:"
          docker-compose ps
          
          # 12. Teste da API com timeout maior
          echo "🏥 Testando API..."
          SUCCESS=false
          for i in {1..15}; do
            if curl -f -s --max-time 15 http://localhost:5000/api/simple/ping > /tmp/health.json; then
              API_VERSION=\$(cat /tmp/health.json | python3 -c "import sys, json; print(json.load(sys.stdin).get('version', 'unknown'))" 2>/dev/null || echo "unknown")
              echo "✅ API respondendo! Versão: \$API_VERSION"
              echo "📋 Resposta completa:"
              cat /tmp/health.json | python3 -m json.tool 2>/dev/null || cat /tmp/health.json
              
              # Verificar se a versão foi atualizada
              if [ "\$API_VERSION" = "${IMAGE_TAG:0:7}" ]; then
                echo "🎉 VERSÃO ATUALIZADA CORRETAMENTE!"
                SUCCESS=true
                break
              else
                echo "⚠️ Versão ainda não atualizada (esperado: ${IMAGE_TAG:0:7}, atual: \$API_VERSION)"
              fi
              break
            else
              echo "⚠️ Tentativa \$i/15 falhou..."
              if [ \$i -eq 5 ] || [ \$i -eq 10 ]; then
                echo "📋 Logs do container web:"
                docker-compose logs web --tail=10
              fi
              sleep 3
            fi
          done
          
          # 13. Executar migrações
          echo "🗄️ Aplicando migrações..."
          docker-compose exec -T web flask db upgrade || echo "⚠️ Erro nas migrações"
          
          # 14. Restaurar docker-compose.yml original
          echo "🔄 Restaurando docker-compose.yml..."
          git checkout -- docker-compose.yml
          
          if [ "\$SUCCESS" = true ]; then
            echo "✅ DEPLOY CONCLUÍDO COM SUCESSO!"
          else
            echo "⚠️ Deploy executado, mas versão pode não ter atualizado"
          fi
          
          echo "🌐 Acesse: https://cron.juscash.app/api/simple/ping"
        EOF

    - name: 🔔 Verificação Externa Final
      run: |
        echo "🌐 Aguardando propagação externa..."
        sleep 20
        
        echo "📡 Verificando versão externa..."
        for i in {1..8}; do
          if RESPONSE=\$(curl -f -s --max-time 15 https://cron.juscash.app/api/simple/ping 2>/dev/null); then
            echo "✅ API externa acessível!"
            echo "📋 Resposta: \$RESPONSE"
            
            # Extrair versão da resposta
            VERSION=\$(echo "\$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin).get('version', 'unknown'))" 2>/dev/null || echo "unknown")
            echo "🔖 Versão externa: \$VERSION"
            echo "🔖 Versão esperada: ${{ github.sha }}".substring(0,7)
            
            break
          else
            echo "⚠️ Tentativa \$i/8 falhou, aguardando..."
            sleep 10
          fi
        done

    - name: ❌ Notificar se falhou
      if: failure()
      run: |
        echo "❌ Deploy falhou!"
        echo "📋 Commit: ${{ github.sha }}"
        echo "🌿 Branch: ${{ github.ref_name }}"
        echo "🔍 Verifique os logs acima para mais detalhes" 