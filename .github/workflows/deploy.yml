name: Deploy to VPS

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: juscash-api
  DOCKER_TAG: ${{ github.sha }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        python -m pytest tests/ -v --tb=short || true

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 30
    if: github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 20m
        command_timeout: 20m
        script: |
          cd /var/www/juscash
          
          # 1. Backup do banco (opcional)
          # docker-compose exec -T db pg_dump -U juscash juscash_db > /tmp/backup_$(date +%Y%m%d_%H%M%S).sql 2>/dev/null || true
          
          # 2. Limpar conflitos Git
          git stash --include-untracked
          git clean -fd
          
          # 3. Atualizar c√≥digo
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}
          
          # 4. Parar apenas o container web (preservar banco)
          docker-compose stop web
          docker-compose rm -f web
          
          # 5. Build otimizado (sem --no-cache para ser mais r√°pido)
          docker-compose build web
          
          # 6. Iniciar containers
          docker-compose up -d
          
          # 7. Aguardar inicializa√ß√£o
          echo "‚è≥ Aguardando containers iniciarem..."
          sleep 15
          
          # 7.5. Configurar banco de dados
          echo "üóÑÔ∏è Configurando banco de dados..."
          docker-compose exec -T db psql -U postgres -c "SELECT 1 FROM pg_database WHERE datname='juscash_db'" | grep -q 1 || {
              echo "üìù Criando usu√°rio e banco..."
              docker-compose exec -T db psql -U postgres <<EOF
          DO \$\$
          BEGIN
              IF NOT EXISTS (SELECT FROM pg_catalog.pg_user WHERE usename = 'juscash') THEN
                  CREATE USER juscash WITH PASSWORD 'juscash123';
              END IF;
          END
          \$\$;
          
          SELECT 'CREATE DATABASE juscash_db OWNER juscash'
          WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'juscash_db')\gexec
          
          GRANT ALL PRIVILEGES ON DATABASE juscash_db TO juscash;
          EOF
          }
          
          # 8. Aplicar migra√ß√µes
          docker-compose exec -T web flask db upgrade || true
          
          # 9. Verificar se est√° rodando
          for i in {1..10}; do
            if curl -f -s http://localhost:5000/api/simple/ping; then
              echo "‚úÖ API respondendo!"
              exit 0
            fi
            echo "Tentativa $i/10..."
            sleep 3
          done
          
          echo "‚ùå API n√£o respondeu ap√≥s 10 tentativas"
          docker-compose logs --tail=50
          exit 1 