name: ğŸš€ CI/CD - Deploy JusCash API

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  test:
    name: ğŸ§ª Testes Automatizados
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Cache dependÃªncias Python
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ğŸ“‹ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8

    - name: ğŸ” Lint com flake8
      run: |
        flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: ğŸ§ª Executar testes
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test-secret-key
        FLASK_ENV: testing
      run: |
        flask db upgrade
        pytest tests/ -v --cov=app --cov-report=xml --cov-report=term

    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  deploy:
    name: ğŸš€ Deploy para VPS
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    environment:
      name: production
      url: https://cron.juscash.app

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: ğŸ“‹ Adicionar servidor aos hosts conhecidos
      run: |
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸš€ Deploy para servidor
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USER }}
        DEPLOY_BRANCH: ${{ github.ref_name }}
        DEPLOY_SHA: ${{ github.sha }}
      run: |
        ssh $VPS_USER@$VPS_HOST << EOF
          set -e
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ğŸš€ INICIANDO DEPLOY AUTOMÃTICO                     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“… Data/Hora: \$(date)"
          echo "ğŸŒ¿ Branch: $DEPLOY_BRANCH"
          echo "ğŸ”– Commit SHA: $DEPLOY_SHA"
          
          # Navegar para diretÃ³rio do projeto
          cd /var/www/juscash
          
          # Criar diretÃ³rio de backups se nÃ£o existir
          mkdir -p backups
          
          # Backup do banco de dados (se disponÃ­vel)
          echo ""
          echo "ğŸ’¾ Fazendo backup do banco de dados..."
          if docker-compose exec -T db pg_dump -U juscash juscash_db > backups/backup_\$(date +%Y%m%d_%H%M%S).sql 2>/dev/null; then
            echo "âœ… Backup criado com sucesso"
          else
            echo "âš ï¸  Backup falhou (banco pode estar vazio) - continuando deploy..."
          fi
          
          # Salvar estado atual dos containers
          echo ""
          echo "ğŸ“¸ Salvando estado atual dos containers..."
          docker-compose ps > backups/containers_state_\$(date +%Y%m%d_%H%M%S).txt
          
          # Atualizar cÃ³digo
          echo ""
          echo "ğŸ“¥ Atualizando cÃ³digo fonte..."
          echo "ğŸ”„ Branch atual: \$(git branch --show-current)"
          
          # Limpar alteraÃ§Ãµes locais
          git stash push -m "Auto-stash before deploy \$(date)" || true
          git checkout -- .
          git clean -fd
          
          # Buscar atualizaÃ§Ãµes
          git fetch origin --prune
          git checkout $DEPLOY_BRANCH || git checkout -b $DEPLOY_BRANCH origin/$DEPLOY_BRANCH
          git reset --hard origin/$DEPLOY_BRANCH
          
          # Criar arquivo de versÃ£o
          echo ""
          echo "ğŸ“ Criando arquivo de versÃ£o..."
          echo "\$(git rev-parse --short HEAD)" > VERSION
          echo "âœ… VersÃ£o registrada: \$(cat VERSION)"
          echo "ğŸ“‹ Ãšltimo commit: \$(git log --oneline -1)"
          
          # Verificar e corrigir permissÃµes
          echo ""
          echo "ğŸ”’ Corrigindo permissÃµes..."
          chmod +x docker-entrypoint.sh || echo "âš ï¸  docker-entrypoint.sh nÃ£o encontrado"
          chmod +x *.sh 2>/dev/null || true
          
          # Parar containers graciosamente
          echo ""
          echo "â¹ï¸  Parando containers atuais..."
          docker-compose stop || echo "âš ï¸  Alguns containers podem nÃ£o estar rodando"
          
          # Aguardar containers pararem completamente
          echo "â³ Aguardando containers pararem..."
          sleep 5
          
          # Remover containers antigos
          echo ""
          echo "ğŸ—‘ï¸  Removendo containers antigos..."
          docker-compose down --remove-orphans || true
          
          # Limpar volumes nÃ£o utilizados (cuidado com dados!)
          echo ""
          echo "ğŸ§¹ Limpando volumes nÃ£o utilizados..."
          docker volume prune -f || true
          
          # Build com cache otimizado
          echo ""
          echo "ğŸ”¨ Construindo nova imagem Docker..."
          echo "â„¹ï¸  Usando BuildKit para otimizaÃ§Ã£o de cache"
          
          # Pull de imagens base para garantir versÃµes atualizadas
          docker-compose pull --ignore-pull-failures || true
          
          # Build com output detalhado
          if docker-compose build --no-cache --pull; then
            echo "âœ… Build concluÃ­do com sucesso"
          else
            echo "âŒ Erro no build - tentando build sem cache..."
            docker-compose build --no-cache || exit 1
          fi
          
          # Iniciar containers
          echo ""
          echo "ğŸš€ Iniciando novos containers..."
          if docker-compose up -d --force-recreate --remove-orphans; then
            echo "âœ… Containers iniciados"
          else
            echo "âŒ Erro ao iniciar containers"
            docker-compose logs --tail=50
            exit 1
          fi
          
          # Aguardar inicializaÃ§Ã£o
          echo ""
          echo "â³ Aguardando serviÃ§os inicializarem..."
          echo -n "Aguardando"
          for i in {1..30}; do
            echo -n "."
            sleep 1
          done
          echo ""
          
          # Verificar status dos containers
          echo ""
          echo "ğŸ“Š Status dos containers:"
          docker-compose ps
          
          # Executar migraÃ§Ãµes
          echo ""
          echo "ğŸ—„ï¸  Aplicando migraÃ§Ãµes do banco de dados..."
          if docker-compose exec -T web flask db upgrade; then
            echo "âœ… MigraÃ§Ãµes aplicadas com sucesso"
          else
            echo "âš ï¸  Erro nas migraÃ§Ãµes - verificando logs..."
            docker-compose logs web --tail=20
            echo "âš ï¸  Continuando mesmo com erro nas migraÃ§Ãµes..."
          fi
          
          # Health checks detalhados
          echo ""
          echo "ğŸ¥ Executando health checks..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          MAX_ATTEMPTS=5
          ATTEMPT=1
          SUCCESS=false
          
          while [ \$ATTEMPT -le \$MAX_ATTEMPTS ]; do
            echo ""
            echo "ğŸ” Tentativa \$ATTEMPT/\$MAX_ATTEMPTS..."
            
            # Verificar se o container web estÃ¡ rodando
            if docker-compose ps web | grep -q "Up"; then
              echo "âœ… Container web estÃ¡ UP"
              
              # Tentar acessar o endpoint de health
              if curl -f -s --max-time 10 http://localhost:5000/api/simple/ping > /tmp/health_response.json; then
                echo "âœ… API respondendo corretamente"
                echo "ğŸ“‹ Resposta do health check:"
                cat /tmp/health_response.json | python3 -m json.tool || cat /tmp/health_response.json
                
                # Verificar se a versÃ£o estÃ¡ correta
                API_VERSION=\$(cat /tmp/health_response.json | python3 -c "import sys, json; print(json.load(sys.stdin).get('version', 'unknown'))" 2>/dev/null || echo "parse_error")
                FILE_VERSION=\$(cat VERSION)
                
                echo ""
                echo "ğŸ”– VersÃ£o no arquivo: \$FILE_VERSION"
                echo "ğŸ”– VersÃ£o na API: \$API_VERSION"
                
                if [ "\$API_VERSION" = "\$FILE_VERSION" ]; then
                  echo "âœ… VersÃµes coincidem - Deploy verificado!"
                  SUCCESS=true
                  break
                else
                  echo "âš ï¸  VersÃµes nÃ£o coincidem - API pode nÃ£o ter atualizado ainda"
                fi
              else
                echo "âŒ API nÃ£o estÃ¡ respondendo"
                echo "ğŸ“‹ Logs recentes do container web:"
                docker-compose logs web --tail=10
              fi
            else
              echo "âŒ Container web nÃ£o estÃ¡ rodando"
              docker-compose ps
            fi
            
            if [ \$ATTEMPT -lt \$MAX_ATTEMPTS ]; then
              echo "â³ Aguardando 15 segundos antes da prÃ³xima tentativa..."
              sleep 15
            fi
            
            ATTEMPT=\$((ATTEMPT + 1))
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "\$SUCCESS" = true ]; then
            echo "âœ… DEPLOY REALIZADO COM SUCESSO!"
            
            # Limpeza pÃ³s-deploy
            echo ""
            echo "ğŸ§¹ Executando limpeza pÃ³s-deploy..."
            
            # Remover imagens antigas
            docker image prune -f --filter "until=24h" || true
            
            # Manter apenas os 5 backups mais recentes
            cd backups
            ls -t backup_*.sql 2>/dev/null | tail -n +6 | xargs -r rm || true
            ls -t containers_state_*.txt 2>/dev/null | tail -n +6 | xargs -r rm || true
            cd ..
            
            echo ""
            echo "ğŸ“Š InformaÃ§Ãµes finais do deploy:"
            echo "ğŸŒ¿ Branch: $DEPLOY_BRANCH"
            echo "ğŸ”– Commit: \$(git rev-parse --short HEAD)"
            echo "ğŸ“… Data/Hora: \$(date)"
            echo "ğŸŒ URL: https://cron.juscash.app"
            
          else
            echo "âŒ DEPLOY FALHOU!"
            echo "Verifique os logs acima para identificar o problema."
            
            # Tentar rollback
            echo ""
            echo "ğŸ”„ Tentando rollback para versÃ£o anterior..."
            git reset --hard HEAD~1
            docker-compose down
            docker-compose up -d --build
            
            exit 1
          fi
        EOF
        
        # Verificar se o comando SSH teve sucesso
        SSH_EXIT_CODE=\$?
        if [ \$SSH_EXIT_CODE -ne 0 ]; then
          echo "âŒ Deploy falhou! Comando SSH retornou cÃ³digo de erro: \$SSH_EXIT_CODE"
          exit 1
        fi
        
        echo ""
        echo "âœ… Pipeline de deploy concluÃ­do com sucesso!"

    - name: ğŸ”” VerificaÃ§Ã£o final do deploy
      if: success()
      run: |
        echo "ğŸ‰ Deploy realizado com sucesso!"
        echo "ğŸ“‹ Commit deployado: ${{ github.sha }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸŒ Verificando API..."
        
        # Aguardar um pouco para garantir que o proxy reverso atualizou
        sleep 10
        
        # Tentar acessar a API externa
        if curl -f -s --max-time 15 https://cron.juscash.app/api/simple/ping; then
          echo "âœ… API estÃ¡ acessÃ­vel externamente!"
        else
          echo "âš ï¸  API nÃ£o estÃ¡ acessÃ­vel externamente ainda (pode levar alguns segundos)"
        fi

    - name: âŒ Notificar falha
      if: failure()
      run: |
        echo "âŒ Deploy falhou!"
        echo "Verifique os logs do GitHub Actions para mais detalhes." 